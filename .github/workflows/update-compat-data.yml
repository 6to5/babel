name: Update compat data
env:
  YARN_ENABLE_SCRIPTS: false # disable post-install scripts
on:
  workflow_dispatch:
    inputs: {}
  schedule:
    - cron: "0 0 * * 5"

jobs:
  createPullRequest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/checkout@v2
        with:
          repository: kangax/compat-table
          path: packages/babel-compat-data/build/compat-table
      - name: Use Node.js latest
        uses: actions/setup-node@v2-beta
        with:
          node-version: "*"
      - name: Get latest kangax/compat-data commit
        id: lastCommit
        run: echo "::set-output name=sha1::$(node ./scripts/update-compat-data/get-last-commit.sh)"
      - name: Compare last kangax/compat-data commit with current one
        run: echo ${{ steps.lastCommit.outputs.sha1 }} | node ./scripts/update-compat-data/compare-with-current-commit.js
      - name: Update compat-data commit
        run: echo ${{ steps.lastCommit.outputs.sha1 }} | ./scripts/update-compat-data/bump-data-compat-version.sh
      - name: Run update script
        run: make build-compat-data
      - name: Commit changes
        run: |
          git config user.name "Babel Bot"
          git config user.email "babel-bot@users.noreply.github.com"
          git checkout -b update-compat-data
          git commit -am "chore: update compat data to ${{ steps.lastCommit.outputs.sha1 }}"
          git push --force origin update-compat-data
      - name: Create Pull Request
        uses: babel/actions/create-pull-request@v2
        with:
          token: ${{ secrets.BOT_TOKEN }}
          branch: update-compat-data
          title: Update compat data
          description: Update compat data to [${{ steps.lastCommit.outputs.sha1 }}](https://github.com/kangax/compat-table/commit/${{ steps.lastCommit.outputs.sha1 }}).
          labels: |
            area: compat-data
            repo automation :robot:
